---
title: "Poorman's EDA"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE
)
```

Setup stuff. I just exported some of the initial stuff cuz my laptop started to sound like a jet engine upon knitting.

```{r }
library(tidyverse)
library(janitor)
# source(here::here("scripts", "cleaning.R"))
# source(here::here("scripts", "gg_field.R"))

# # Choose single play (highest EPA) for example.
# example_play <-
#   plays %>% 
#   inner_join(games) %>% 
#   # arrange(desc(epa)) %>% 
#   slice_max(epa) %>% # just found out about this black magic
#   select(week, game_id, play_id, epa, play_description)
# example_play
```

Add positions and filter down to example play.

If this weren't an example, we wouldn't actually need to the join on the play (`example_play`), unless we want to use something that is only in `plays`, such as `EPA`.

```{r cache=FALSE}
positions <- read_csv(here::here("data/positions.csv"))
all_weeks <- read_csv(here::here("data/highest_epa_example_data.csv"))
games <- 
  read_csv(here::here("data/games.csv")) %>% 
  clean_names() %>% 
  mutate(game_date = lubridate::mdy(game_date))

plays <- 
  read_csv(here::here("data/plays.csv")) %>% 
  clean_names() %>% 
  # There are 2 of these. Not sure what to do with them... drop them.
  filter(!is.na(pass_result))

tracking_init <-
  all_weeks %>% 
  # inner_join(example_play %>% select(game_id, play_id), by = c("game_id", "play_id")) %>%
  # Add offense/defense/special teams designation
  left_join(positions %>% select(position, category = side))
tracking_init
```

Give the ball it's own columns (and remove the `"Football"` rows.) Also, add some useful player columns (`dist` and `y_side`). Haven't used actually used these for anything useful yet tho...

```{r }
# Probably should make this a function to be used anywhere.
compute_dist <- function(x1, y1, x2, y2) {
  sqrt((x1 - x2)^2 + (y1 - y2)^2)
}

ball <- tracking_init %>% filter(display_name == "Football")
tracking <- 
  tracking_init %>% 
  filter(display_name != "Football") %>% 
  inner_join(ball %>% select(game_id, play_id, frame_id, ball_x = x, ball_y = y)) %>% 
  # Not actually use these yet.
  mutate(
    dist = compute_dist(x, y, ball_x, ball_y),
    y_side = case_when(y <= 160/3/2 ~ "left", TRUE ~ "right")
  )
tracking
```

Doing some manipulation (`play_direction`, `line_of_scrimmage`, and `possession`) that could be useful in our main cleaning script.

```{r}
snap_frame <- tracking %>% filter(event == "ball_snap")
# Reference: https://github.com/danichusfu/RouteIdentification/blob/master/R/read_routes_from_csv.R
play_direction <-
  snap_frame %>% 
  group_by(game_id, play_id, team) %>%
  summarise(mean_team = mean(x)) %>%
  ungroup() %>% 
  filter(mean_team == max(mean_team)) %>%
  select(game_id, play_id, direction_left = team, -mean_team)

line_of_scrimmage <-
  snap_frame %>% 
  group_by(game_id, play_id, team) %>%
  summarise(right_scrim = max(x), left_scrim = min(x)) %>% 
  ungroup()

possession <-
  plays %>%
  select(game_id, play_id, possession_team) %>%
  left_join(games, by = "game_id") %>%
  mutate(possesion = if_else(possession_team == home_team_abbr, "home", "away")) %>%
  select(game_id, play_id, possesion)

tracking_clean <-
  tracking %>% 
  left_join(play_direction, by = c("game_id", "play_id")) %>% 
  left_join(line_of_scrimmage, by = c("team", "game_id", "play_id")) %>% 
  left_join(possession, by = c("game_id", "play_id"))
tracking_clean
```

Trimming down frames to just what we care about.

```{r }
# Filter out stuff before the snap and after the pass has arrived.
# My attempt at making a full list of events where the route should be considered over.
# This is like https://github.com/danichusfu/RouteIdentification/blob/master/R/cut_plays.R.
events_end_route <- c(
  # "None",
  # "ball_snap",
  # "pass_forward",
  # "pass_arrived",
  "pass_outcome_caught",
  # "first_contact",
  # "tackle",
  "pass_outcome_incomplete",
  # "play_action",
  # "out_of_bounds",
  # "line_set",
  "qb_sack",
  # "man_in_motion",
  "pass_outcome_interception",
  # "touchdown",
  # "pass_tipped",
  # "fumble",
  "pass_outcome_touchdown",
  "qb_strip_sack",
  # "fumble_defense_recovered",
  # "fumble_offense_recovered",
  # "shift",
  # "handoff",
  # "pass_shovel",
  # "penalty_flag",
  # "run",
  "qb_spike" # ,
  # "touchback",
  # "field_goal_blocked",
  # "penalty_accepted"
)

tracking_filtered <-
  tracking_clean %>%
  group_by(game_id, play_id, nfl_id) %>% 
  mutate(
    group = case_when(
      event == "ball_snap" ~ 1L,
      lag(event) %in% events_end_route ~ 1L,
      TRUE ~ 0L
    ),
    group = cumsum(group)
  ) %>%
  ungroup() %>% 
  filter(group == 1L) %>%
  select(-group)
tracking_filtered
```

Key points in the play that are interesting to annotate.

```{r}
throw_frame <- tracking_filtered %>% filter(event == "pass_forward")
# Probably need a full list of events for pass arriving...
end_frame <- tracking_filtered %>% filter(event %in% events_end_route)
frames_annotate <- list(snap_frame, throw_frame, end_frame) %>% reduce(bind_rows)
```

Plot

```{r}
# field <- gg_field() # Couldn"t get this to work with the rest of the ggplot latyers...
shapes <- c('ball_snap' = 21, 'pass_forward' = 22, set_names(rep(23, length(events_end_route)), events_end_route))
viz <-
  # field +
  ggplot() +
  theme_minimal() +
  aes(x = x, y = y, group = nfl_id, color = category) +
  geom_path(data = tracking_filtered) +
  geom_point(
    data = frames_annotate,
    aes(fill = category, shape = event),
    # shape = 21,
    size = 6,
    color = 'black'
  ) +
  ggrepel::geom_label_repel(
    data = end_frame %>% filter(!is.na(route)),
    aes(label = route),
    # shape = 21,
    # arrow = arrow(length = unit(0.2, 'npc')),
    hjust = -2,
    size = 5,
    color = 'black'
  ) +
  scale_shape_manual(values = shapes) + 
  geom_text(
    data = frames_annotate,
    aes(label = jersey_number),
    size = 3,
    color = 'white'
  )
viz
```
